from flask import Flask, render_template_string, request, redirect, session
import random

app = Flask(__name__)
app.secret_key = "your_secret_key"

# Create 1000 credentials
users = {f"192411{i}": "CSA0826" for i in range(1000, 1501)}
users.update({f"192311{i}": "CSA0332" for i in range(1000, 1501)})

python_questions = [
    ("Which is a Python keyword?", ["def", "add", "func", "define"], "def"),
    ("Which data type is immutable?", ["List", "Set", "Dictionary", "Tuple"], "Tuple"),
    ("What does len() do?", ["Counts elements", "Sorts items", "Deletes items", "Calculates average"], "Counts elements"),
    ("Which symbol defines a function?", ["func", "def", "function", "define"], "def"),
    ("Output of type(10)?", ["int", "float", "str", "bool"], "int"),
    ("Loop structure in Python?", ["repeat", "for", "do while", "loop"], "for"),
    ("Convert string to integer?", ["str()", "int()", "float()", "bool()"], "int()"),
    ("Module for regex?", ["regex", "re", "match", "pyregex"], "re"),
    ("Start comment in Python?", ["--", "#", "//", "/*"], "#"),
    ("Keyword for loop?", ["iterate", "while", "loop", "run"], "while")
]

ds_questions = [
    ("FIFO data structure?", ["Stack", "Queue", "Tree", "Graph"], "Queue"),
    ("Not linear structure?", ["Array", "Queue", "Stack", "Tree"], "Tree"),
    ("LIFO structure?", ["Queue", "Array", "Stack", "Graph"], "Stack"),
    ("Best case of binary search?", ["O(n)", "O(log n)", "O(1)", "O(n log n)"], "O(1)"),
    ("Height of balanced tree?", ["log n", "n", "n/2", "1"], "log n"),
    ("BFS uses?", ["Stack", "Queue", "Heap", "Tree"], "Queue"),
    ("Invalid traversal?", ["Inorder", "Preorder", "Postorder", "Aroundorder"], "Aroundorder"),
    ("For priority tasks?", ["Stack", "Queue", "Priority Queue", "Array"], "Priority Queue"),
    ("Function call mgmt?", ["Array", "Queue", "Stack", "Graph"], "Stack"),
    ("Linear search time?", ["O(n)", "O(log n)", "O(1)", "O(n log n)"], "O(n)")
]

@app.route('/', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        uid = request.form['user_id']
        pwd = request.form['password']
        if uid in users and users[uid] == pwd:
            session['user_id'] = uid
            session['questions'] = random.sample(python_questions if uid.startswith("1924") else ds_questions, 10)
            return redirect('/exam')
        else:
            return render_template_string(login_page, error="Invalid ID or password")
    return render_template_string(login_page, error="")

@app.route('/exam', methods=['GET', 'POST'])
def exam():
    if 'user_id' not in session:
        return redirect('/')
    if request.method == 'POST':
        questions = session['questions']
        score = 0
        for i, (_, opts, ans) in enumerate(questions):
            if request.form.get(f'q{i}') == ans:
                score += 1
        session.clear()
        return f\"\"\"<h2>Result</h2>
        <p>Score: {score}/10</p>
        <p>Percentage: {score * 10}%</p>
        <a href='/'>Return</a>\"\"\"
    return render_template_string(exam_page, questions=session['questions'])

# Templates
login_page = \"\"\"\"
<!DOCTYPE html>
<html><body>
<h2>Student Login</h2>
<form method='POST'>
  User ID: <input name='user_id' required><br>
  Password: <input name='password' type='password' required><br><br>
  <input type='submit' value='Login'>
</form>
<p style='color:red;'>{{ error }}</p>
</body></html>
\"\"\"

exam_page = \"\"\"\"
<!DOCTYPE html>
<html><body>
<h2>Online Exam - Time: 5 mins</h2>
<form method='POST' id='examForm'>
{% for idx, (q, opts, ans) in enumerate(questions) %}
  <p><b>{{ idx+1 }}. {{ q }}</b></p>
  {% for opt in opts|random %}
    <label><input type='radio' name='q{{ idx }}' value='{{ opt }}'> {{ opt }}</label><br>
  {% endfor %}
{% endfor %}
<br><input type='submit' value='Submit Exam'>
</form>
<script>
let mins = 4, secs = 60;
let timer = setInterval(() => {
  if (--secs < 0) { secs = 59; mins--; }
  if (mins < 0) { clearInterval(timer); document.getElementById('examForm').submit(); }
}, 1000);
</script>
</body></html>
\"\"\"

if __name__ == '__main__':
    app.run(debug=True)
